I have wrote this code with the help of Foster's inout2.c file.
I believe everything works under all conditions.
